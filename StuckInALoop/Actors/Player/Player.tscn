[gd_scene load_steps=4 format=2]

[ext_resource path="res://Pete/Player/PlayerModel.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends RigidBody2D

export var run_speed = 200
export var dash_speed = 600
var state = PlayerStates.idle
var state_time = 0
var target_velocity = Vector2.ZERO
var target_angle = 0
onready var collider = $CollisionShape2D
onready var camera = $PlayerCamera
onready var target = $PlayerSprite/Target

enum PlayerStates{
	enter_idle,
	idle,
	run,
	dash
}

# Called when the node enters the scene tree for the first time.
func _ready():
	Game.player = self

func _input(event):
	if event is InputEventMouseMotion:
		if (event.get_relative().length() > 1):
			controller = false

var controller = false

func look_at_target():
	var x = Input.get_action_strength(\"player_look_right\") - Input.get_action_strength(\"player_look_left\")
	var y = -Input.get_action_strength(\"player_look_up\") + Input.get_action_strength(\"player_look_down\")
	if (Vector2(x,y).length() > .1):
		controller = true
		target_angle = Vector2.UP.angle_to(Vector2(x,y))
		Input.set_mouse_mode(Input.MOUSE_MODE_HIDDEN)
	if (!controller):
		var mousepos = camera.get_global_mouse_position()-global_position
		target_angle = Vector2.UP.angle_to(mousepos)
		Input.set_mouse_mode(Input.MOUSE_MODE_CONFINED)
	
func _process(delta):
	process_statemachine(delta)
	pass
	
func _integrate_forces(pstate):
	pstate.angular_velocity = 0
	pstate.linear_velocity = lerp(pstate.linear_velocity, target_velocity, .25)
	var t = Transform2D(target_angle, pstate.transform.origin)
	pstate.transform = t
	
func change(new_state):
	state = new_state
	state_time = 0
	#print(\"player state : \", new_state)

func player_move_input():
	var x = Input.get_action_strength(\"player_move_right\") - Input.get_action_strength(\"player_move_left\")
	var y = -Input.get_action_strength(\"player_move_up\") + Input.get_action_strength(\"player_move_down\")
	return Vector2(x, y)

func try_dash():
	if (Input.is_action_just_pressed(\"dash\")):
		change(PlayerStates.dash)
		return true
	return false

func get_forward():
	return (target.global_position - global_position).normalized()

func try_shoot():
	if (Input.is_action_just_pressed(\"player_shoot\")):
		var bullet = load(\"res://Pete/Bullet/Bullet.tscn\").instance()
		bullet.global_position = target.global_position
		bullet.velocity = get_forward()
		get_tree().current_scene.add_child(bullet)

func process_statemachine(delta):
	try_shoot()
	state_time += delta
	match (state):
		PlayerStates.enter_idle:
			change(PlayerStates.idle)
			
		PlayerStates.idle:
			target_velocity = Vector2.ZERO
			if (player_move_input().length() > .1):
				change(PlayerStates.run)
			if (try_dash()):
				target_velocity = get_forward()
			look_at_target()
			
		PlayerStates.run:
			if (player_move_input().length() < .1):
				change(PlayerStates.enter_idle)
			target_velocity = player_move_input() * run_speed
			try_dash()
			look_at_target()
			
		PlayerStates.dash:
			if (state == PlayerStates.idle):
				target_velocity = target.global_position - global_position
			target_velocity = target_velocity.normalized() * (dash_speed + run_speed)
			if (state_time > .25):
				change(PlayerStates.enter_idle)
"

[sub_resource type="CircleShape2D" id=2]
radius = 33.9532

[node name="Player" type="RigidBody2D"]
rotation = -0.00908171
collision_layer = 2
gravity_scale = 0.0
can_sleep = false
script = SubResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = SubResource( 2 )

[node name="PlayerSprite" parent="." instance=ExtResource( 1 )]

[node name="Target" type="Node2D" parent="PlayerSprite"]
position = Vector2( 0, -100 )

[node name="PlayerCamera" type="Camera2D" parent="."]
current = true
