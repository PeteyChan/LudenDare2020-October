[gd_scene load_steps=5 format=2]

[ext_resource path="res://icon.png" type="Texture" id=1]

[sub_resource type="GDScript" id=2]
script/source = "extends RigidBody2D

enum grunt_states {
	enter_idle,
	idle,
	enter_run,
	run 
	}

enum grunt_ai {
	idle,
	chase,
	flee,
	attack
}

export var run_speed = 100
var target 
var current_state = grunt_states.enter_idle
var current_ai = grunt_ai.idle
var state_time = 0
var ai_time = 0
var velocity = Vector2.ZERO
var move_input = Vector2.ZERO

func _on_DetectionArea_body_entered(body):
	target = body

func _on_DetectionArea_body_exited(body):
	target = null

func _process(delta):
	#print(grunt_states.keys()[current_state], \" \", grunt_ai.keys()[current_ai], \" \", move_input)	
	if (target != null):
		print(target.global_position)
	state_time += delta
	process_statemachine(delta)
	process_ai(delta)
	pass

func change_state(state):
	state_time = 0
	current_state = state
	pass

func change_ai(behaviour):
	ai_time = 0
	current_ai = behaviour
	pass

func distance_to_target():
	return (global_position - target.global_position).length()

func _integrate_forces(state):
	state.angular_velocity = 0
	state.linear_velocity = velocity
	pass

func process_statemachine(delta):
	match(current_state):
		grunt_states.enter_idle:
			#play idle animation
			velocity = Vector2.ZERO
			change_state(grunt_states.idle)
		
		grunt_states.idle:
			if (move_input.length() > .1):
				change_state(grunt_states.enter_run)
		
		grunt_states.enter_run:
			#play run animation
			change_state(grunt_states.run)
			
		grunt_states.run:
			if (move_input.length() < .1):
				change_state(grunt_states.enter_idle)
			velocity = move_input * run_speed
		
		_: return

func process_ai(delta):
	match(current_ai):
		grunt_ai.idle:
			move_input = Vector2.ZERO
			if (target != null):
				change_ai(grunt_ai.chase)
		
		grunt_ai.chase:
			if (target == null):
				change_ai(grunt_ai.idle)
			else:
				print (target.name)
				move_input = (target.global_position - global_position).normalized()		
		_: return
	pass
"

[sub_resource type="CircleShape2D" id=3]
radius = 324.368

[sub_resource type="CircleShape2D" id=1]
radius = 33.836

[node name="Grunt" type="RigidBody2D"]
gravity_scale = 0.0
can_sleep = false
script = SubResource( 2 )

[node name="DetectionArea" type="Area2D" parent="."]
collision_layer = 0
collision_mask = 2

[node name="DetectionShape" type="CollisionShape2D" parent="DetectionArea"]
shape = SubResource( 3 )

[node name="icon" type="Sprite" parent="."]
modulate = Color( 1, 0, 0, 1 )
texture = ExtResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = SubResource( 1 )
[connection signal="body_entered" from="DetectionArea" to="." method="_on_DetectionArea_body_entered"]
[connection signal="body_exited" from="DetectionArea" to="." method="_on_DetectionArea_body_exited"]
